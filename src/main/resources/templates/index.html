<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–Ω–µ–≤–Ω–∏–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .trades-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="datetime-local"] {
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.edit-btn {
            background-color: #f39c12;
            padding: 5px 10px;
            font-size: 12px;
        }
        button.edit-btn:hover {
            background-color: #e67e22;
        }
        button.save-btn {
            background-color: #27ae60;
            padding: 5px 10px;
            font-size: 12px;
        }
        button.save-btn:hover {
            background-color: #229954;
        }
        button.cancel-btn {
            background-color: #95a5a6;
            padding: 5px 10px;
            font-size: 12px;
        }
        button.cancel-btn:hover {
            background-color: #7f8c8d;
        }
        button.delete-btn {
            background-color: #e74c3c;
            padding: 5px 10px;
            font-size: 12px;
        }
        button.delete-btn:hover {
            background-color: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .buy { color: #27ae60; }
        .sell { color: #e74c3c; }
        .status-open { color: #f39c12; }
        .status-closed { color: #27ae60; }
        .profit-positive { color: #27ae60; }
        .profit-negative { color: #e74c3c; }
        .commission { color: #e74c3c; }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .edit-input {
            width: 100px;
            padding: 2px 4px;
            font-size: 11px;
        }
        .table-container {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìà –î–Ω–µ–≤–Ω–∏–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫</h1>
        <p>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏</p>
    </div>

    <div class="summary">
        <h2>–°–≤–æ–¥–∫–∞</h2>
        <div class="summary-stats">
            <div class="stat-card">
                <h3 th:text="${summary.totalTrades}">0</h3>
                <p>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</p>
            </div>
            <div class="stat-card">
                <h3 th:text="${#numbers.formatDecimal(summary.profitablePercentage, 1, 1)} + '%'">0.0%</h3>
                <p>–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</p>
            </div>
            <div class="stat-card">
                <h3 th:text="${#numbers.formatDecimal(summary.totalProfit, 1, 2)}" 
                    th:class="${summary.totalProfit != null and summary.totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}">0.00</h3>
                <p>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</p>
            </div>
        </div>
    </div>

    <div class="form-container">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É</h2>
        <form id="tradeForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="symbol">–°–∏–º–≤–æ–ª:</label>
                    <input type="text" id="symbol" name="symbol" required placeholder="AAPL, MSFT...">
                </div>
                
                <div class="form-group">
                    <label for="side">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:</label>
                    <select id="side" name="side" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        <option value="BUY">–ü–æ–∫—É–ø–∫–∞ (BUY)</option>
                        <option value="SELL">–ü—Ä–æ–¥–∞–∂–∞ (SELL)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <input type="number" id="quantity" name="quantity" step="0.01" required placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="entryPrice">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</label>
                    <input type="number" id="entryPrice" name="entryPrice" step="0.00001" required placeholder="1.35176">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="entryTime">–í—Ä–µ–º—è –≤—Ö–æ–¥–∞:</label>
                    <input type="datetime-local" id="entryTime" name="entryTime">
                </div>
                
                <div class="form-group">
                    <label for="takeProfit">Take Profit:</label>
                    <input type="number" id="takeProfit" name="takeProfit" step="0.00001" placeholder="1.35200">
                </div>
                
                <div class="form-group">
                    <label for="stopLoss">Stop Loss:</label>
                    <input type="number" id="stopLoss" name="stopLoss" step="0.00001" placeholder="1.35100">
                </div>
                
                <div class="form-group">
                    <label for="commission">–ö–æ–º–∏—Å—Å–∏—è:</label>
                    <input type="number" id="commission" name="commission" step="0.01" value="0" placeholder="-3.45">
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">–ó–∞–º–µ—Ç–∫–∏:</label>
                <textarea id="notes" name="notes" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–¥–µ–ª–∫–µ"></textarea>
            </div>
            
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
        </form>
    </div>

    <div class="trades-container">
        <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
        <div th:if="${trades.isEmpty()}">
            <p>–°–¥–µ–ª–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
        </div>
        <div th:unless="${trades.isEmpty()}" class="table-container">
            <table id="tradesTable">
                <thead>
                    <tr>
                        <th>–°–∏–º–≤–æ–ª</th>
                        <th>–¢–∏–ø</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–í—Ö–æ–¥</th>
                        <th>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞</th>
                        <th>–í—ã—Ö–æ–¥</th>
                        <th>–í—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞</th>
                        <th>Take Profit</th>
                        <th>Stop Loss</th>
                        <th>–ö–æ–º–∏—Å—Å–∏—è</th>
                        <th>–ü—Ä–∏–±—ã–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ó–∞–º–µ—Ç–∫–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="trade : ${trades}" th:data-trade-id="${trade.id}">
                        <td th:text="${trade.symbol}"></td>
                        <td th:text="${trade.side}" th:class="${trade.side == T(ru.vavtech.tradebook.model.TradeSide).BUY ? 'buy' : 'sell'}"></td>
                        <td th:text="${#numbers.formatDecimal(trade.quantity, 1, 2)}"></td>
                        <td th:text="${#numbers.formatDecimal(trade.entryPrice, 1, 5)}"></td>
                        <td th:text="${#temporals.format(trade.entryTime, 'dd.MM.yy HH:mm')}"></td>
                        <td th:text="${trade.exitPrice != null ? #numbers.formatDecimal(trade.exitPrice, 1, 5) : '-'}"></td>
                        <td th:text="${trade.exitTime != null ? #temporals.format(trade.exitTime, 'dd.MM.yy HH:mm') : '-'}"></td>
                        <td th:text="${trade.takeProfit != null ? #numbers.formatDecimal(trade.takeProfit, 1, 5) : '-'}"></td>
                        <td th:text="${trade.stopLoss != null ? #numbers.formatDecimal(trade.stopLoss, 1, 5) : '-'}"></td>
                        <td th:text="${#numbers.formatDecimal(trade.commission, 1, 2)}" class="commission"></td>
                        <td th:text="${trade.profit != null ? #numbers.formatDecimal(trade.profit, 1, 2) : '-'}"
                            th:class="${trade.profit != null and trade.profit >= 0 ? 'profit-positive' : 'profit-negative'}"></td>
                        <td th:text="${trade.status}" th:class="${trade.status == T(ru.vavtech.tradebook.model.TradeStatus).OPEN ? 'status-open' : 'status-closed'}"></td>
                        <td th:text="${trade.notes}"></td>
                        <td>
                            <button class="edit-btn" th:data-trade-id="${trade.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="delete-btn" th:data-trade-id="${trade.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É</h2>
            <form id="editForm">
                <input type="hidden" id="editTradeId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editExitPrice">–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞:</label>
                        <input type="number" id="editExitPrice" step="0.00001" placeholder="1.35176">
                    </div>
                    
                    <div class="form-group">
                        <label for="editExitTime">–í—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞:</label>
                        <input type="datetime-local" id="editExitTime">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editTakeProfit">Take Profit:</label>
                        <input type="number" id="editTakeProfit" step="0.00001" placeholder="1.35200">
                    </div>
                    
                    <div class="form-group">
                        <label for="editStopLoss">Stop Loss:</label>
                        <input type="number" id="editStopLoss" step="0.00001" placeholder="1.35100">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCommission">–ö–æ–º–∏—Å—Å–∏—è:</label>
                        <input type="number" id="editCommission" step="0.01" placeholder="-3.45">
                    </div>
                    
                    <div class="form-group">
                        <label for="editProfit">–ü—Ä–∏–±—ã–ª—å:</label>
                        <input type="number" id="editProfit" step="0.01" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editStatus">–°—Ç–∞—Ç—É—Å:</label>
                        <select id="editStatus">
                            <option value="">–ù–µ –º–µ–Ω—è—Ç—å</option>
                            <option value="OPEN">–û—Ç–∫—Ä—ã—Ç–∞</option>
                            <option value="CLOSED">–ó–∞–∫—Ä—ã—Ç–∞</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">–ó–∞–º–µ—Ç–∫–∏:</label>
                    <textarea id="editNotes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="cancel-btn" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('entryTime').value = now.toISOString().slice(0, 16);
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
        document.getElementById('tradeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const tradeData = {
                symbol: formData.get('symbol'),
                side: formData.get('side'),
                quantity: parseFloat(formData.get('quantity')),
                entryPrice: parseFloat(formData.get('entryPrice')),
                entryTime: formData.get('entryTime') || null,
                takeProfit: formData.get('takeProfit') ? parseFloat(formData.get('takeProfit')) : null,
                stopLoss: formData.get('stopLoss') ? parseFloat(formData.get('stopLoss')) : null,
                commission: parseFloat(formData.get('commission') || 0),
                notes: formData.get('notes') || ''
            };
            
            try {
                const response = await fetch('/api/trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tradeData)
                });
                
                if (response.ok) {
                    alert('–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-btn')) {
                const tradeId = e.target.getAttribute('data-trade-id');
                editTrade(tradeId);
            } else if (e.target.classList.contains('delete-btn')) {
                const tradeId = e.target.getAttribute('data-trade-id');
                deleteTrade(tradeId);
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function editTrade(tradeId) {
            fetch(`/api/trades/${tradeId}`)
                .then(response => response.json())
                .then(trade => {
                    document.getElementById('editTradeId').value = trade.id;
                    document.getElementById('editExitPrice').value = trade.exitPrice || '';
                    document.getElementById('editExitTime').value = trade.exitTime ? new Date(trade.exitTime).toISOString().slice(0, 16) : '';
                    document.getElementById('editTakeProfit').value = trade.takeProfit || '';
                    document.getElementById('editStopLoss').value = trade.stopLoss || '';
                    document.getElementById('editCommission').value = trade.commission || '';
                    document.getElementById('editProfit').value = trade.profit || '';
                    document.getElementById('editStatus').value = trade.status || '';
                    document.getElementById('editNotes').value = trade.notes || '';
                    
                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–∫–∏');
                });
        }

        function deleteTrade(tradeId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                fetch(`/api/trades/${tradeId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
                });
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ X
        document.querySelector('.close').addEventListener('click', closeEditModal);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tradeId = document.getElementById('editTradeId').value;
            const updateData = {};
            
            const exitPrice = document.getElementById('editExitPrice').value;
            if (exitPrice) updateData.exitPrice = parseFloat(exitPrice);
            
            const exitTime = document.getElementById('editExitTime').value;
            if (exitTime) updateData.exitTime = exitTime;
            
            const takeProfit = document.getElementById('editTakeProfit').value;
            if (takeProfit) updateData.takeProfit = parseFloat(takeProfit);
            
            const stopLoss = document.getElementById('editStopLoss').value;
            if (stopLoss) updateData.stopLoss = parseFloat(stopLoss);
            
            const commission = document.getElementById('editCommission').value;
            if (commission) updateData.commission = parseFloat(commission);
            
            const profit = document.getElementById('editProfit').value;
            if (profit) updateData.profit = parseFloat(profit);
            
            const status = document.getElementById('editStatus').value;
            if (status) updateData.status = status;
            
            const notes = document.getElementById('editNotes').value;
            if (notes) updateData.notes = notes;
            
            try {
                const response = await fetch(`/api/trades/${tradeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    alert('–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        });
    </script>
</body>
</html> 